name: <Native> Generate OH SDK Cache

on:
  workflow_dispatch:
    inputs:
      oh_sdk_version:
        description: 'Openharmony SDK version'
        type: string
        default: '9'
        required: true

jobs:
  generate_oh_sdk_cache:
    name: "Generate OH SDK cache"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-java@v4
        id: setup-jdk
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Get oh sdk cache directory path
        id: oh-sdk-cache-dir-path
        run: |
          echo "cache dir: "
          echo "dir=$HOME/openharmony" >> $GITHUB_OUTPUT

      - name: Output cache dir
        run: |
          echo "Output cache dir: ${{ steps.oh-sdk-cache-dir-path.outputs.dir }}"

      - name: Cache OH SDK
        id: cache-oh-sdk
        uses: actions/cache@v4
        env:
          cache-name: cache-oh-sdk-${{ github.event.inputs.oh_sdk_version }}
        with:
          path: ${{ steps.oh-sdk-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}

      - name: Add package.json
        run: |
          echo "{}" > package.json
          echo "{\"name\": \"tests\",\"lockfileVersion\": 3,\"requires\": true,\"packages\": {}}" > package-lock.json
      - uses: actions/setup-node@v4
        with:
          node-version: 14
          cache: 'npm'

      - if: ${{ steps.cache-oh-sdk.outputs.cache-hit != 'true' }}
        name: No Cache found, install oh sdk
        continue-on-error: false
        run: |
          if [ ! -d "$HOME/openharmony" ]; then
            mkdir -p $HOME/openharmony
            echo "Download commandline-tools-linux.zip ..."
            curl -o commandline-tools-linux.zip "https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_901_9/b8/v3/D1h9RzdeTZ-7Ga_hPu95DA/commandline-tools-linux-x64-5.0.3.906.zip?HW-CC-KV=V1&HW-CC-Date=20241119T025229Z&HW-CC-Expire=7200&HW-CC-Sign=88A1ABE766E5F72E7D78BC405443250A08421906EBB6B57C967D1FB32C47004F"
            echo "Unzip commandline-tools-linux.zip ..."
            unzip commandline-tools-linux.zip -d $HOME/openharmony > /dev/null
            cd $HOME/openharmony
            ls -l
            cd command-line-tools
            ls -l
          fi